name: Release API Module

on:
  push:
    branches:
      - main
      - v1
      - release/**
    paths:
      - "api/**"
  workflow_dispatch:

jobs:
  release-api:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check for api/ changes
        id: changes
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Compare with parent commit to see if api/ files changed
          if git diff --name-only HEAD~1 HEAD | grep -q '^api/'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute next api version
        if: steps.changes.outputs.changed == 'true'
        id: version
        run: |
          # Find latest api/v* tag
          LATEST=$(git tag -l 'api/v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST" ]; then
            NEXT="api/v0.1.0"
          else
            # Strip api/v prefix, bump patch
            VER="${LATEST#api/v}"
            MAJOR=$(echo "$VER" | cut -d. -f1)
            MINOR=$(echo "$VER" | cut -d. -f2)
            PATCH=$(echo "$VER" | cut -d. -f3)
            PATCH=$((PATCH + 1))
            NEXT="api/v${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "tag=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Next API version: $NEXT"

      - name: Create and push tag
        if: steps.changes.outputs.changed == 'true'
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub release
        if: steps.changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          VER="${TAG#api/}"
          PREV=$(git tag -l 'api/v*' --sort=-v:refname | sed -n '2p')
          CHANGELOG=""
          if [ -n "$PREV" ]; then
            CHANGES=$(git log "${PREV}..${TAG}" --pretty=format:"- %s" -- api/)
            if [ -n "$CHANGES" ]; then
              CHANGELOG="### Changes
          ${CHANGES}"
            fi
          fi
          gh release create "$TAG" \
            --title "API Module ${VER}" \
            --target "$COMMIT_SHA" \
            --notes "### Usage
          \`\`\`bash
          go get github.com/NexusGPU/tensor-fusion/api@${VER}
          \`\`\`

          ${CHANGELOG}"
